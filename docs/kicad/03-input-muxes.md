# Section 3: Input Muxes

## Components

| Ref | Component | KiCad Symbol | Notes |
|-----|-----------|-------------|-------|
| U4 | CD4053B #1 (direct) | `Analog_Switch:CD4053B` | V_LOW/V_HIGH → X1, X2 |
| U5 | CD4053B #2 (complement) | `Analog_Switch:CD4053B` | V_HIGH/V_LOW → X1_COMP, X2_COMP (swapped!) |
| R_SW1 | Switch isolation X1 | `Device:R` | 10kΩ |
| R_SW2 | Switch isolation X2 | `Device:R` | 10kΩ |
| SW1 | X1 toggle switch | `Switch:SW_SPDT` | Inference mode input 1 |
| SW2 | X2 toggle switch | `Switch:SW_SPDT` | Inference mode input 2 |

## CD4053B Pin Mapping

**KiCad naming note:** In KiCad 6+ (post symbol library fix MR #2378), the CD4053B uses
channel names A/B/C with suffixes 0/1/c (common). Older KiCad versions used X/Y/Z naming.
This guide uses the **current KiCad 6+ naming**: `A0`, `A1`, `Ac`, `B0`, `B1`, `Bc`, `C0`, `C1`, `Cc`.
The TI datasheet calls the channels A/B/C with inputs labeled AX/AY, BX/BY, CX/CY.

The CD4053B has three independent 2:1 mux channels (A, B, C). Each channel has:
- A common pin (bidirectional I/O): Ac, Bc, Cc
- Two selectable pins: x0 (selected when control LOW) and x1 (selected when control HIGH)
- A control/select pin (A, B, C)

When control is LOW: common connects to pin 0.
When control is HIGH: common connects to pin 1.

Additional pins:
- VDD → `+5V`
- VSS → `GND`
- VEE → `GND` (negative supply, tie to GND for single-supply)
- INH (inhibit) → `GND` (active high — tie low to enable all channels)

## CD4053B #1 (U4) — Direct Inputs

| Pin Function | KiCad Pin (6+) | Net |
|-------------|----------------|-----|
| VDD | VDD | `+5V` |
| VSS | VSS | `GND` |
| VEE | VEE | `GND` |
| INH | INH | `GND` |
| Ch A control | A | `MUX_A` |
| Ch B control | B | `MUX_B` |
| Ch C control | C | `GND` (unused, tie low) |
| Ch A common | Ac | `X1` |
| Ch A select-0 (ctrl LOW) | A0 | `V_LOW` |
| Ch A select-1 (ctrl HIGH) | A1 | `V_HIGH` |
| Ch B common | Bc | `X2` |
| Ch B select-0 (ctrl LOW) | B0 | `V_LOW` |
| Ch B select-1 (ctrl HIGH) | B1 | `V_HIGH` |
| Ch C common | Cc | `GND` (unused, tie to GND) |
| Ch C select-0 | C0 | `GND` |
| Ch C select-1 | C1 | `GND` |

Result: MUX_A=LOW → X1=V_LOW (1V), MUX_A=HIGH → X1=V_HIGH (4V).

## CD4053B #2 (U5) — Complementary Inputs (SWAPPED)

Identical to U4 except V_LOW and V_HIGH are swapped on the selectable pins:

| Pin Function | KiCad Pin (6+) | Net |
|-------------|----------------|-----|
| VDD | VDD | `+5V` |
| VSS | VSS | `GND` |
| VEE | VEE | `GND` |
| INH | INH | `GND` |
| Ch A control | A | `MUX_A` |
| Ch B control | B | `MUX_B` |
| Ch C control | C | `GND` |
| Ch A common | Ac | `X1_COMP` |
| Ch A select-0 (ctrl LOW) | A0 | `V_HIGH` ← SWAPPED |
| Ch A select-1 (ctrl HIGH) | A1 | `V_LOW` ← SWAPPED |
| Ch B common | Bc | `X2_COMP` |
| Ch B select-0 (ctrl LOW) | B0 | `V_HIGH` ← SWAPPED |
| Ch B select-1 (ctrl HIGH) | B1 | `V_LOW` ← SWAPPED |
| Ch C common | Cc | `GND` |
| Ch C select-0 | C0 | `GND` |
| Ch C select-1 | C1 | `GND` |

Result: MUX_A=LOW → X1_COMP=V_HIGH (4V), MUX_A=HIGH → X1_COMP=V_LOW (1V).
So X1 + X1_COMP always = 5V. Complement generated by physics.

## Toggle Switches (Inference Mode)

During training, the Arduino drives MUX_A and MUX_B directly.
During inference (Arduino removed), toggle switches provide the control signals.
10kΩ isolation resistors prevent contention when both are connected.

```
                        ┌──── CD4053 #1 & #2 control A (pin A)
Arduino D2 (MUX_A) ────┤
                        └──── R_SW1 (10kΩ) ──── SW1 common
                                                  SW1 throw 1 → +5V
                                                  SW1 throw 2 → GND
```

```
                        ┌──── CD4053 #1 & #2 control B (pin B)
Arduino D3 (MUX_B) ────┤
                        └──── R_SW2 (10kΩ) ──── SW2 common
                                                  SW2 throw 1 → +5V
                                                  SW2 throw 2 → GND
```

In KiCad: the `MUX_A` net connects to Arduino D2, both CD4053 A pins, and one end
of R_SW1. The other end of R_SW1 goes to SW1 common. SW1 throws go to `+5V` and `GND`.
Same pattern for MUX_B.

## Arduino ADC Sense Connections

The Arduino measures input voltages for firmware use:
- `X1` net also connects to Arduino A0 (`SENSE_X1`)
- `X2` net also connects to Arduino A1 (`SENSE_X2`)

In KiCad, just run a wire from the X1 mux output node to the Arduino A0 pin.
Both share the same net. You can use a net label `X1` on both ends.

## Input Pattern Truth Table (verification)

| MUX_A (D2) | MUX_B (D3) | X1 | X1_COMP | X2 | X2_COMP | Pattern |
|------------|------------|-----|---------|-----|---------|---------|
| LOW | LOW | 1.0V | 4.0V | 1.0V | 4.0V | (0,0) |
| LOW | HIGH | 1.0V | 4.0V | 4.0V | 1.0V | (0,1) |
| HIGH | LOW | 4.0V | 1.0V | 1.0V | 4.0V | (1,0) |
| HIGH | HIGH | 4.0V | 1.0V | 4.0V | 1.0V | (1,1) |

## Decoupling

- C_U4 (100nF): U4 VDD to GND, close to IC
- C_U5 (100nF): U5 VDD to GND, close to IC
